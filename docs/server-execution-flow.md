# 서버 실행 절차 도식화

## 전체 실행 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 사용자 명령 실행                                              │
│    $ bun dev  또는  $ bun run server.js                        │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. server.js 로드                                               │
│    - import { build, serve } from "bun"                         │
│    - import { watch, existsSync } from "fs"                     │
│    - import { config } from "./config.js"  ← 여기서 config.js 실행│
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. config.js 실행 (환경 변수 검증 및 설정)                      │
│                                                                  │
│    ┌──────────────────────────────────────────┐                │
│    │ 3-1. DEFAULTS 상수 정의                  │                │
│    │     - PORT, ENTRY_FILE, HTML_ENTRY 등     │                │
│    └──────────────────────────────────────────┘                │
│                     │                                            │
│                     ▼                                            │
│    ┌──────────────────────────────────────────┐                │
│    │ 3-2. Zod 스키마로 process.env 검증       │                │
│    │     - envSchema.parse(process.env)      │                │
│    │     - 검증 실패 시 에러 출력 후 종료     │                │
│    └──────────────────────────────────────────┘                │
│                     │                                            │
│                     ▼                                            │
│    ┌──────────────────────────────────────────┐                │
│    │ 3-3. BASE_PATH로 개발/배포 구분          │                │
│    │     - BASE_PATH 있음 → isProduction=true │                │
│    │     - BASE_PATH 없음 → isDevelopment=true│                │
│    │     - NODE_ENV 자동 설정                 │                │
│    └──────────────────────────────────────────┘                │
│                     │                                            │
│                     ▼                                            │
│    ┌──────────────────────────────────────────┐                │
│    │ 3-4. config 객체 export                  │                │
│    │     - port, isDevelopment, isProduction  │                │
│    │     - basename, entryFile, buildOptions 등│                │
│    └──────────────────────────────────────────┘                │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. 모드 판단 및 로그 출력                                       │
│    - isPreview = config.isProduction                           │
│    - MODE = isPreview ? "production" : "dev"                    │
│    - 🚀 Starting Bun server in {MODE} mode                      │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. 의존성 확인 및 설치                                           │
│    ┌──────────────────────────────────────────┐                │
│    │ if (!existsSync("./node_modules"))       │                │
│    │   → Bun.spawn(["bun", "install"])        │                │
│    │   → 설치 완료까지 대기                   │                │
│    └──────────────────────────────────────────┘                │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
┌──────────────────┐   ┌──────────────────┐
│ 개발 모드        │   │ 배포 모드        │
│ (BASE_PATH 없음) │   │ (BASE_PATH 있음) │
└────────┬─────────┘   └────────┬─────────┘
         │                      │
         ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6-1. 개발 모드: 초기 번들링                                     │
│    - bundleOnce("initial") 실행                                │
│    - build({ entrypoints, outdir, ...config.buildOptions })     │
│    - dist/index.js 생성                                         │
└────────────────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6-2. 개발 모드: 파일 감시 시작                                  │
│    - watch("./src", { recursive: true })                        │
│    - .js, .jsx, .ts, .tsx, .css 변경 감지                      │
│    - 변경 시 → bundleOnce("watch") 실행                        │
└────────────────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6-3. 개발 모드: 아이콘 인덱스 감시 시작                         │
│    - watch(config.iconsDir, { recursive: true })                │
│    - .svg 파일 변경 감지                                        │
│    - 변경 시 → Bun.spawn(["bun", "run", "scripts/update-icons.js"])│
│    - src/assets/icons/index.js 자동 갱신                        │
└────────────────────┬────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 7. HTTP 서버 시작 (공통)                                        │
│    ┌──────────────────────────────────────────┐                │
│    │ serve({                                  │                │
│    │   port: config.port,                     │                │
│    │   fetch: async (req) => { ... }          │                │
│    │ })                                        │                │
│    └──────────────────────────────────────────┘                │
│                     │                                            │
│                     ▼                                            │
│    ┌──────────────────────────────────────────┐                │
│    │ 요청 처리 로직:                           │                │
│    │                                          │                │
│    │ 1. HTML 요청 (/ 또는 /index.html)        │                │
│    │    → index.html 읽기                    │                │
│    │    → placeholder 치환                    │                │
│    │    → dist/index.js 경로 삽입             │                │
│    │                                          │                │
│    │ 2. 정적 파일 요청 (/images/*, /sound/*)  │                │
│    │    → public/ 디렉토리에서 서빙           │                │
│    │                                          │                │
│    │ 3. 번들 파일 요청 (/dist/*)               │                │
│    │    → dist/ 디렉토리에서 서빙             │                │
│    │                                          │                │
│    │ 4. 기타 요청                              │                │
│    │    → 404 Not Found                       │                │
│    └──────────────────────────────────────────┘                │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│ 8. 서버 실행 완료                                               │
│    ✅ Server running at http://localhost:{port}                 │
│    ✅ 개발 모드: 파일 감시 및 핫 리로드 활성화                  │
│    ✅ 배포 모드: 정적 파일만 서빙                               │
└─────────────────────────────────────────────────────────────────┘
```

## 모드별 상세 흐름

### 개발 모드 (BASE_PATH 없음)

```
┌─────────────────────────────────────────────────────────────┐
│ 개발 모드 실행 흐름                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 1. config.js                                                 │
│    → BASE_PATH 없음 감지                                     │
│    → isDevelopment = true                                    │
│    → isProduction = false                                   │
│    → NODE_ENV = "development" (자동 설정)                    │
│                                                              │
│ 2. 초기 번들링                                               │
│    → bundleOnce("initial")                                   │
│    → build({ minify: true, sourcemap: "external" })         │
│    → dist/index.js 생성                                      │
│                                                              │
│ 3. 파일 감시 활성화                                          │
│    → watch("./src")                                         │
│    → 파일 변경 시 자동 재빌드                                │
│                                                              │
│ 4. 아이콘 감시 활성화                                        │
│    → watch("./src/assets/icons")                            │
│    → SVG 변경 시 index.js 자동 갱신                          │
│                                                              │
│ 5. 서버 시작                                                 │
│    → localhost:3000에서 서빙                                 │
│    → 변경 사항 자동 반영                                     │
└─────────────────────────────────────────────────────────────┘
```

### 배포 모드 (BASE_PATH 있음)

```
┌─────────────────────────────────────────────────────────────┐
│ 배포 모드 실행 흐름                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 1. config.js                                                 │
│    → BASE_PATH 있음 감지 (예: /coffee-kiosk)                │
│    → isProduction = true                                     │
│    → isDevelopment = false                                   │
│    → NODE_ENV = "production" (자동 설정)                    │
│                                                              │
│ 2. 번들링 건너뛰기                                           │
│    → bundleOnce() 실행 안 함                                 │
│    → "먼저 'bun run build'를 실행하세요" 메시지              │
│                                                              │
│ 3. 파일 감시 비활성화                                        │
│    → watch() 실행 안 함                                      │
│                                                              │
│ 4. 아이콘 감시 비활성화                                      │
│    → watch() 실행 안 함                                      │
│                                                              │
│ 5. 서버 시작                                                 │
│    → localhost:3000에서 서빙                                 │
│    → dist/ 디렉토리의 정적 파일만 서빙                        │
│    → (빌드는 사전에 완료되어 있어야 함)                      │
└─────────────────────────────────────────────────────────────┘
```

## 주요 파일 역할

| 파일 | 역할 |
|------|------|
| `server.js` | 메인 서버 진입점, 번들링, 파일 감시, HTTP 서버 |
| `config.js` | 환경 변수 검증, 기본값 설정, 개발/배포 모드 구분 |
| `set-base-path.js` | 빌드 시에만 실행, BASE_PATH 자동 설정 |
| `build.js` | 빌드 스크립트, set-base-path.js 실행 후 번들링 |

## 환경 변수 흐름

```
┌─────────────────────────────────────────────────────────────┐
│ 환경 변수 설정 우선순위                                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 1. .env 파일 (선택사항)                                      │
│    → Bun이 자동으로 로드                                     │
│    → process.env에 주입                                      │
│                                                              │
│ 2. 시스템 환경 변수                                          │
│    → 이미 설정된 값이 있으면 사용                            │
│                                                              │
│ 3. config.js의 DEFAULTS                                     │
│    → 환경 변수가 없을 때 기본값 사용                          │
│                                                              │
│ 4. BASE_PATH 자동 감지 (빌드 시에만)                         │
│    → set-base-path.js가 Git 리포지토리 이름 감지             │
│    → BASE_PATH = /{repo-name} 설정                          │
│    → NODE_ENV = production (BASE_PATH 있으면)                │
└─────────────────────────────────────────────────────────────┘
```

## 요청 처리 흐름

```
HTTP 요청
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ serve() fetch 핸들러                                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 요청 URL 분석                                                │
│    │                                                         │
│    ├─→ / 또는 /index.html                                   │
│    │   → index.html 읽기                                    │
│    │   → placeholder 치환                                   │
│    │   → dist/index.js 경로 삽입                            │
│    │   → HTML 반환                                          │
│    │                                                         │
│    ├─→ /images/*, /sound/*, /menu_data.json                │
│    │   → public/ 디렉토리에서 파일 서빙                      │
│    │   → 파일 반환                                          │
│    │                                                         │
│    ├─→ /dist/*                                              │
│    │   → dist/ 디렉토리에서 파일 서빙                        │
│    │   → 파일 반환                                          │
│    │                                                         │
│    └─→ 기타                                                  │
│        → 404 Not Found                                       │
└─────────────────────────────────────────────────────────────┘
```

## 핵심 포인트

1. **BASE_PATH로 자동 구분**: 환경 변수 없이도 BASE_PATH 존재 여부로 개발/배포 모드 자동 판단
2. **의존성 자동 설치**: node_modules 없으면 자동 설치
3. **핫 리로드**: 개발 모드에서 파일 변경 시 자동 재빌드
4. **아이콘 자동 인덱싱**: SVG 파일 변경 시 index.js 자동 갱신
5. **환경 변수 검증**: Zod로 런타임 검증, 잘못된 설정 시 즉시 종료

